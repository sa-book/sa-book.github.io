---
title: "Sequence length and granularity"
description: |
  Chapter 2.2 Defining sequences
output: distill::distill_article    
---

```{r setup, include=FALSE}
# Load and download (if necessary) required packages ----

# Save package names as a vector of strings
pkgs <- c("colorspace", "glue", "here", "Hmisc", "htmltools", "kableExtra", 
          "knitr", "patchwork", "pdftools", "RColorBrewer", "reshape2", 
          "sjPlot", "tidyverse", "TraMineR", "TraMineRextras", "xaringanExtra") 

# Options that might help to prevent some errors in the installation process
options(install.packages.check.source = "no")
options(install.packages.compile.from.source = "never")

## Install uninstalled packages
lapply(pkgs[!(pkgs %in% installed.packages())], 
       install.packages, repos = getOption("repos")["CRAN"])

## Load all packages to library and adjust options
lapply(pkgs, library, character.only = TRUE)

# Output options
knitr::opts_chunk$set(eval=TRUE, echo=TRUE)
options("kableExtra.html.bsTable" = T)

# load data for Chapter 2
load(here("data", "2-0_ChapterSetup.RData"))

```

```{r, xaringanExtra-clipboard, echo=FALSE}
htmltools::tagList(
  xaringanExtra::use_clipboard(
    button_text = "<i class=\"fa fa-clone fa-2x\" style=\"color: #301e64\"></i>",
    success_text = "<i class=\"fa fa-check fa-2x\" style=\"color: #90BE6D\"></i>",
    error_text = "<i class=\"fa fa-times fa-2x\" style=\"color: #F94144\"></i>"
  ),
  rmarkdown::html_dependency_font_awesome()
)
```

**Table 2.2** in Chapter 2.2 compares different approaches towards defining sequence data.

The sequences consist of monthly information on respondents' partnership status between age 18 to 40 (monthly data). The sequences are stored in the object `partner.month.seq` and distinguish four states:

```{r echo=FALSE}
tibble(State = longlab.partner, 
       `Short Label` = shortlab.partner) %>% 
kable() %>%
  kable_styling(bootstrap_options = c("responsive", "hover", "condensed"),
                full_width = F)
```



In addition to simply using the original data, two alternative approaches of defining the sequences are discussed:

-   The first alternative aims at reducing the complexity of the original data by imposing a threshold rule that defines a minimum length for partnership spells. If a spell falls below this threshold value, it would be discounted and the respective states coded as being single rather than in a relationship. The data manipulation required for this alternative sequence specification was done in Stata. Hence, we only have to import the dataset from Stata and define it a sequence object using similar code than in [Chapter 2-1](rChapter2-1.html).

```{r, eval = FALSE}
# import alternative version of sequence data 
family2 <- read_dta("partnerRecodedThreshold12.dta")

# store sequence variables in a separate object
seqvars2.partner <- family2 %>%
  select(starts_with("state"))

# define long and short labels
shortlab.partner <- c("S", "LAT", "COH", "MAR")
longlab.partner <-  c("Single", "LAT", "Cohabiting", "Married")

# define sequence object using monthly data
partner.month.seq2 <- seqdef(seqvars2.partner,
                             states = shortlab.partner,
                             labels = longlab.partner,
                             weights = family2$weight40)

```

-   The second strategy changes the granularity of the sequence data from monthly to yearly. That is, twelve states from the original sequence are condensed to one state in the new sequence by applying the `seqgranularity` function from the `{TraMineRextras}` package.

```{r}
# change granularity --> years instead of months (using modal values)
partner.year.seq <- seqgranularity(partner.month.seq, 
                               tspan=12, method="mostfreq")
```

Now we can produce **Table 2.2** from the book which shows a small selection of four sequences using the three different specifications.


```{r, eval=FALSE}

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Table 2.2 - Different alternatives of defining sequences ----
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# Using original Sequence data (monthly granularity) (column 1)
col1 <- print(partner.month.seq[c(4, 8, 16, 21), ], format = "SPS")

# Using recoded monthly data only considering
# spells lasting at least 12 months (column 2)
col2 <- print(partner.month.seq2[c(4, 8, 16, 21), ], format = "SPS")

# Using sequences with yearly granularity (Column 3)
col3 <- print(partner.year.seq[c(4, 8, 16, 21), ], format = "SPS")
```

```{r, include=FALSE}
# Using original Sequence data (monthly granularity) (column 1)
col1 <- print(partner.month.seq[c(4, 8, 16, 21), ], format = "SPS")

# Using recoded monthly data only considering
# spells lasting at least 12 months (column 2)
col2 <- print(partner.month.seq2[c(4, 8, 16, 21), ], format = "SPS")

# Using sequences with yearly granularity (Column 3)
col3 <- print(partner.year.seq[c(4, 8, 16, 21), ], format = "SPS")

```

```{r, layout="l-page"}
# Print selection of sequences from differently specified sequence data
tibble(col1, col2, col3) %>%
  kable(col.names = c("Original sequence", 
                      "Strategy 1 – recode", 
                      "Strategy 2 – aggregate")) %>%
  kable_styling(bootstrap_options = 
                  c("striped", "hover", "condensed", "responsive"))

```

